# LINK 雙卡註冊流程

## 註冊流程概述

LINK 使用雙卡認證系統，需要兩張 NFC 卡片來完成註冊：
1. **主卡**（Primary Card）- 日常登入使用
2. **副卡/備用卡**（Backup Card）- 用於緊急撤銷主卡

## Step 1: 生成卡片對

### 在 Admin Panel 生成
1. 訪問 https://link.mcphub.tw/admin
2. 輸入密碼：`link-admin-2024-secure`
3. 點擊「產生新卡片對」
4. 系統會生成兩個 token：
   - 卡片 A (主卡)：`https://link.mcphub.tw/w/[token-1]`
   - 卡片 B (副卡)：`https://link.mcphub.tw/w/[token-2]`

### Token 結構
```
d8544616490d074f-1-7bca2eca
└────────────┘ └┘ └────────┘
    UUID       卡號   HMAC
```

## Step 2: 燒錄到 NFC 卡片

將生成的 URL 燒錄到 NTAG 424 DNA 卡片：
1. 使用 NFC 燒錄工具（如 TagWriter）
2. 將 URL 寫入卡片的 NDEF 記錄
3. 設定為 URL 類型，這樣手機掃描會自動開啟瀏覽器

## Step 3: 雙卡註冊流程

### 3.1 掃描第一張卡（主卡）
1. 用手機掃描第一張 NFC 卡片
2. 自動開啟瀏覽器並訪問 `/w/[token-1]`
3. 後端檢查卡片狀態：`can_register`
4. 重定向到 `/register?token=[token-1]`
5. 顯示「掃描主卡成功，請掃描副卡」

### 3.2 掃描第二張卡（副卡）
1. 在註冊頁面點擊「掃描副卡」
2. 掃描第二張 NFC 卡片
3. 系統驗證兩張卡片是否為配對
4. 確認後進入設定頁面

### 3.3 設定帳號資訊
1. **設定暱稱**
   - 輸入顯示名稱（2-20 字元）
   - 這會是其他人看到的名字

2. **設定密碼**
   - 輸入安全密碼（至少 8 字元）
   - 密碼用於保護帳號安全
   - 配合 NFC 卡片雙重認證

3. **完成註冊**
   - 點擊「完成註冊」
   - 系統建立帳號並綁定兩張卡片
   - 自動登入並跳轉到聊天頁面

## Step 4: 後續登入

### 正常登入（使用主卡）
1. 掃描主卡
2. 系統識別為 `primary` 狀態
3. 重定向到 `/login?token=[token]`
4. 輸入密碼
5. 登入成功

### 緊急撤銷（使用副卡）
1. 掃描副卡
2. 系統識別為 `backup` 狀態
3. 重定向到 `/login/backup?token=[token]`
4. 輸入密碼
5. 選擇是否撤銷主卡
6. 確認後主卡失效，副卡變成新主卡

## 卡片狀態流程圖

```
新卡片對 (can_register)
    ├── 掃描主卡 → /register?token=xxx
    └── 掃描副卡 → /register?token=xxx
        └── 完成註冊
            ├── 主卡 (primary) → /login?token=xxx
            └── 副卡 (backup) → /login/backup?token=xxx
                └── 撤銷主卡
                    ├── 主卡 (revoked) → /error?reason=card_revoked
                    └── 副卡變主卡 (primary) → /login?token=xxx
```

## 資料庫中的狀態

```sql
-- cards 表中的 status 欄位
'unpaired'    -- 未配對（剛生成）
'paired'      -- 已配對但未註冊
'registered'  -- 已註冊
'revoked'     -- 已撤銷

-- card_type 欄位
'primary'     -- 主卡
'backup'      -- 備用卡
```

## 安全機制

1. **雙因素認證**
   - 需要實體 NFC 卡片
   - 需要知道密碼

2. **卡片配對驗證**
   - 兩張卡必須是同一對
   - HMAC 簽名驗證防偽造

3. **撤銷機制**
   - 副卡可緊急撤銷主卡
   - 撤銷後原主卡永久失效
   - 副卡升級為新主卡

## 測試檢查點

- [x] Admin Panel 可生成卡片對
- [x] 卡片 URL 使用正確域名
- [x] 掃描卡片正確重定向
- [ ] 註冊頁面正確顯示
- [ ] 可完成雙卡配對
- [ ] 可設定暱稱密碼
- [ ] 註冊後自動登入
- [ ] 主卡可正常登入
- [ ] 副卡可撤銷主卡

## 常見問題

### Q: 為什麼需要兩張卡？
A: 主卡用於日常登入，副卡是安全備份。如果主卡遺失或被盜，可用副卡撤銷。

### Q: 副卡可以用來登入嗎？
A: 副卡主要用於緊急撤銷。使用副卡登入會提示是否要撤銷主卡。

### Q: 撤銷後原本的主卡還能用嗎？
A: 不行，撤銷是永久的。原主卡會變成 `revoked` 狀態，無法再使用。

### Q: 可以重新配對新卡嗎？
A: 撤銷後，原副卡變成新主卡。需要聯繫管理員生成新的副卡。